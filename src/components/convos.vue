<!-- META INFO -->
<!--
    Test for backend connection and functionality
-->
<!--  -->

<!-- TEMPLATE -->
<template>
  <div class="component">
    <h1>Convos</h1>
    <div v-if="loggedIn">

      <h2>Convo Creator</h2>
      <div class="input-group">
        <input name='convoname' placeholder='Conversation Name' v-model='convoNameEntry'>
        <input name='convomembers' placeholder='Conversation Members' v-model='convoMemberEntry'>
      </div>
      <button v-on:click='createConvo()'>Create Conversation</button>

      <h2>Convo List</h2>
      <div class="list">
        <p v-if="Object.keys(convos).length === 0">No Conversations. Create one to begin.</p>
        <ul v-if="Object.keys(convos).length > 0">
          <li v-for="(item, index) in convos"
            v-bind:class="index === currentIndex ? 'active' : ''">
            <span v-on:click="setActiveConvo(index)" class="item">
              {{item.name}}
            </span>
            <div v-on:click="deleteConvo(index)" class="delete">
              ×
            </div>
          </li>
        </ul>
      </div>

      <div v-if="currentIndex >= 0">
        <h2>{{ convos[currentIndex].name }}</h2>
        <p v-if="Object.keys(messages).length === 0">No Messages in this Conversation. Send one to begin.</p>
        <div class="messages" v-if="currentIndex >= 0">
          <div v-for="item in messages[convos[currentIndex].id]">
            {{ item.sender}} » {{ item.content }}
          </div>

          <input type="text"
            v-model="msgEntry"
            @keydown.enter="sendMessage()"
            placeholder="Message Content"
            :disabled="!websocketReady">
        </div>
      </div>

    </div>
    <div v-else>
      <p>Please log in to see your conversations</p>
    </div>
  </div>
</template>

<!-- SCRIPT -->
<script>
export default {
  props: {
  },

  data () {
    return {
      msgEntry: '',
      convoNameEntry: '',
      convoMemberEntry: '',
      currentIndex: -1
    }
  },

  computed: {
    convos: function () {
      return this.$store.state.convos.content
    },

    messages: function () {
      return this.$store.state.messages.content
    },

    websocketReady: function () {
      if (this.currentIndex >= 0) {
        return this.$store.state.convos.websockets[this.convos[this.currentIndex].id] !== undefined
      } else {
        return false
      }
    },

    loggedIn: function () {
      return this.$store.getters.loggedIn
    }
  },

  methods: {
    sendMessage: function () {
      this.$store.dispatch('sendMessage', {convoIndex: this.currentIndex, content: this.msgEntry})
      this.msgEntry = ''
    },

    receiveMessage: function (event) {
      this.$store.dispatch('receiveMessage', {convoIndex: this.currentIndex, message: JSON.parse(event.data)})
    },

    createConvo: function () {
      // Trims and parses user string into an array of users
      let rawUsersArray = this.convoMemberEntry.split(',')
      let finalUsers = {}
      rawUsersArray.forEach((user) => {
        finalUsers[user.trim()] = true
      })
      this.$store.dispatch('createConvo', {name: this.convoNameEntry, readers: finalUsers, writers: finalUsers})

      this.convoNameEntry = ''
      this.convoMemberEntry = ''
    },

    deleteConvo: function (index) {
      this.$store.dispatch('deleteConvo', index)

      if (index === this.currentIndex) {
        this.unsetActiveConvo()
      }
    },

    setActiveConvo: function (newIndex) {
      // If re-selected current convo, just return
      if (newIndex === this.currentIndex) return

      // If a convo was previously active, then clean up its websocket.
      if (this.currentIndex !== -1) {
        this.$store.dispatch('closeWebsocket', this.convos[this.currentIndex].id)
      }

      // Get id of the new convo
      let convoId = this.convos[newIndex].id

      // Get convo messages from server
      this.$store.dispatch('getMessages', convoId)

      // Create Websocket
      let websocket = new window.WebSocket(
        'ws://' + window.location.host + this.$store.state.backend +
        '/convos/' + convoId + '/start',
        'Bearer+' + this.$store.getters.tokenURL
      )

      websocket.onopen = function () {
        console.log('Websocket connection established.')
      }

      websocket.onmessage = this.receiveMessage
      console.log('Opening websocket connection...')

      this.$store.dispatch('openWebsocket', {websocket, convoId})

      // Set active convo to current index
      this.currentIndex = newIndex
    },

    unsetActiveConvo: function () {
      this.$store.dispatch('closeWebsocket', this.convos[this.currentIndex].id)
      this.currentIndex = -1
    }
  }
}

</script>

<!-- STYLE -->
<style scoped>
.component{
  text-align: center;
  padding: 1.5em;
}
h1,h2,h3,h4{
  font-weight: 200;
  margin-bottom: 0.5em;
}
h1, h2{
  border-bottom: 1px solid #e0d8d0;
}
p{
  color: #a098a0;
}

.list{
  text-align: left;
}
.list ul{
  padding: 0;
}
.list li{
  padding: 0 1em;
  position: relative;
  display: block;
  line-height: 1em;
}
.list li.active{
  color: #fff;
  background: rgba(255,255,255,0.15);
}
.list .item{
  cursor: pointer;
}
.list .item:hover{
  color: #fff;
}
.list .delete{
  font-size: 1.2em;
  opacity: 0.3;
  color: #fff;
  cursor: pointer;
  display: inline-block;
  position: absolute;
  right: 1em;
  text-align: right;
}
.list .delete:hover{
  opacity: 1.0;
}

.messages div{
  width: 100%;
}
.messages div{
  color: #fff;
  font-size: 0.8em;
  line-height: 1.2em;
  margin: 0;
}
.messages div:nth-of-type(even){
  background: rgba(255,255,255,0.15);
}
.api-response{
  margin-top: 0.33em;
  text-align: center;
  font-weight: 100;
  font-size: 0.8em;
}
.api-response.good{ color: #60a060; }
.api-response.bad{ color: #a06060; }

.input-group{
  display: flex;
}
input{
  text-align: center;
  width: 100%;
  margin: 0.5em 0;
  padding: 0.25em;
}
button{
  width: 100%;
}
</style>
